\usepackage{luacode}

\begin{luacode*}
    function get_dirname()
        local dirname = os.env.PWD:match('([^/]+)$')
        return dirname
    end
    function get_default_name(name)
        local dirname = get_dirname()
        return name
    end

    function get_env(var)
        local env = os.env[var]
        return env
    end

    function include_partial(filename, delimiter)
        local contents = io.open(filename, "r"):read("*all")
        local lines = contents:gmatch("([^\r\n]*)\r?\n?")

        local add = false
        for line in lines do
            if line:match("%<*" .. delimiter .. ">") then
                add = true
            end

            if add then
                tex.print(line)
            end

            if line:match("%</" .. delimiter .. ">") then
                add = false
            end
        end
    end
\end{luacode*}

\newcommand{\includepartial}[2]{
    \directlua{include_partial("#1", "#2")}
}
